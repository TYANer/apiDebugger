<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <!-- import CSS -->
  <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="highlight/styles/monokai-sublime.css">
</head>

<body>
  <div id="app" class="container">
    <header>
      <img src="favicon.ico" alt="tgs" style="margin: 6px 0 6px 60px;">
    </header>

    <div class="left">
      <el-scrollbar wrap-class="scrollbar-wrapper" style="height: 100%;">
        <!-- <el-card class="box-card">
          <div slot="header" class="clearfix">
            <span>配置信息</span>
          </div> -->
        <el-alert title="以下内容均为必填项！" type="warning" close-text="知道了">
        </el-alert>
        <el-form :model="formData" ref="baseForm" :rules="rules" style="margin: 20px;">
          <el-row>
            <el-form-item label="环境">
              <el-select v-model="formData.env" placeholder="请选择">
                <el-option v-for="item in selectInfo.env" :key="item" :label="item" :value="item">
                </el-option>
              </el-select>
            </el-form-item>
            <el-form-item label="服务">
              <el-select v-model="formData.service" placeholder="请选择">
                <el-option v-for="item in selectInfo.service" :key="item" :label="item" :value="item">
                </el-option>
              </el-select>
            </el-form-item>
            <el-form-item label="游戏">
              <el-select v-model="formData.game" placeholder="请选择">
                <el-option v-for="item in selectInfo.game" :key="item" :label="item" :value="item">
                </el-option>
              </el-select>
            </el-form-item>
            <el-form-item label="验证方法">
              <el-radio-group v-model="formData.authWay">
                <el-radio label="auth"></el-radio>
                <el-radio label="auth2"></el-radio>
              </el-radio-group>
            </el-form-item>
          </el-row>

          <el-row>
            <el-form-item label="验证类型">
              <el-radio-group v-model="formData.authType">
                <el-radio-button label="0">账户密码</el-radio-button>
                <el-radio-button label="1">Token</el-radio-button>
              </el-radio-group>
            </el-form-item>
            <el-form-item label="用户名" v-if="formData.authType == '0'" prop="username">
              <el-input placeholder="请输入用户名" v-model="formData.username" class="input-with-select">
                <el-select style="width: 130px;" v-model="formData.userType" slot="prepend" placeholder="用户类型">
                  <el-option v-for="item in selectInfo.userType" :key="item" :label="item" :value="item"></el-option>
                </el-select>
              </el-input>
            </el-form-item>
            <el-form-item label="密码" v-if="formData.authType == '0'" prop="password">
              <el-input v-model="formData.password" style="width:258px;"></el-input>
            </el-form-item>
            <el-form-item label="Token" v-else>
              <el-input type="textarea" rows="6" v-model="formData.token" style="width:258px;height: 132px;"></el-input>
            </el-form-item>
          </el-row>

          <el-row>
            <!-- <el-form-item label="Scope"> -->
            <!-- <el-checkbox-group v-model="formData.scopeList">
                  <el-checkbox v-for="item in selectInfo.scope" :key="item" :label="item"></el-checkbox>
                </el-checkbox-group> -->
            <label for="scopetree" class="label">Scope</label>
            <el-tree id="scopetree" :props="defaultProps" :data="selectInfo.scope" show-checkbox node-key="label" ref="tree">
              <!-- </el-form-item> -->
          </el-row>
        </el-form>
        <!-- </el-card> -->
      </el-scrollbar>
    </div>

    <div class="main">
      <section class="middle">
        <el-scrollbar wrap-class="scrollbar-wrapper" style="height: 100%;">

          <section>
            <el-row style="display: flex;">
              <!-- <el-form-item label="请求路径" prop="queryPath"> -->
              <el-input placeholder="请输入路径，例如：/buylist" v-model="formData.queryPath" class="input-with-select">
                <el-select style="width: 120px;text-align: center;" v-model="formData.queryMethod" slot="prepend"
                  placeholder="请求方法">
                  <el-option v-for="item in selectInfo.queryMethod" :key="item" :label="item" :value="item"></el-option>
                </el-select>
              </el-input>
              <el-button type="primary" @click="send('baseForm')" style="margin-left: 20px;">发送请求</el-button>
              <!-- </el-form-item> -->
            </el-row>
            <el-table :data="formData.params" style="width: 100%" size="small">
              <el-table-column label="Key">
                <template slot-scope="scope">
                  <el-input type="text" v-model="scope.row.key" class="edit-input" size="small" @change="isBlank" />
                </template>
              </el-table-column>
              <el-table-column label="Value">
                <template slot-scope="scope">
                  <el-input v-model="scope.row.value" class="edit-input" size="small" @change="isBlank" />
                </template>
              </el-table-column>
              <el-table-column label="Delete" width="80px;">
                <template slot-scope="scope" v-if="scope.$index != (formData.params.length - 1)">
                  <el-button icon="el-icon-delete" size="small" plain type="danger" @click="removeParam(scope.$index)"></el-button>
                </template>
              </el-table-column>
            </el-table>
          </section>

          <!-- <el-row v-for="(item,index) in formData.params">
            <el-form-item>
            <el-input placeholder="请输入内容" v-model="formData.params[index].key">
              <template slot="prepend">key</template>
            </el-input>
            </el-form-item>
            <el-form-item>
            <el-input placeholder="请输入内容" v-model="formData.params[index].value">
              <template slot="prepend">value</template>
            </el-input>
            </el-form-item>
            <el-form-item>
            <el-button icon="el-icon-delete" plain type="danger" @click="removeParam(index)"></el-button>
            </el-form-item>
          </el-row>
          <el-form-item>
          </el-form-item> -->
          <el-card class="box-card">
            <div slot="header" class="clearfix">
              <span>请求结果</span>
            </div>
            <pre><code id="response" class="json">暂无结果</code></pre>
          </el-card>
        </el-scrollbar>
      </section>

      <div class="right">
        <el-scrollbar wrap-class="scrollbar-wrapper" style="height: 100%;">right
        </el-scrollbar>
      </div>
    </div>
  </div>
</body>
<!-- import Vue before Element -->
<script src="https://unpkg.com/vue/dist/vue.js"></script>
<!-- import JavaScript -->
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<script src="highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<!-- import Axios -->
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
  new Vue({
    el: '#app',
    data() {
      return {
        rules: {
          password: [
            { required: true, message: '请输入密码', trigger: 'blur' }
          ],
          username: [
            { required: true, message: '请输入用户名', trigger: 'blur' }
          ],
          queryPath: [
            { required: true, message: '请输入路径', trigger: 'blur' }
          ]
        },
        defaultProps: {
          children: 'children',
          label: 'label'
        },
        selectInfo: {
          env: ['dev', 'beta', 'gold'],
          service: ['auth2', 'chat', 'gateway', 'message', 'pay2', 'translate', 'auth', 'file-server', 'geoip', 'link', 'pay', 'ucenter'],
          game: ['tgstest', 'ba', 'G301', 'g303', 'B001', 'c4'],
          userType: ['anonymous', 'tap4fun', 'system', 'game', 'facebook', 'twitter', 'weibo', 'googleplus', 'mobojoy', '360', 'uc', 'downjoy',
            'xiaomi', 'qq', 'weixin', 'ly', 'openweixin', 'openqq', 'baidu', 'vivo', 'huawei', 'oppo', '1sdk', 'gamecenter'],
          queryMethod: ['GET', 'POST', 'PUT', 'DELETE'],
          scope: [{
            label: '游戏服务账号权限',
            children: [{
              label: 'auth'
            }, {
              label: 'ads'
            }, {
              label: 'auth_game_admin'
            }, {
              label: 'ads_rw'
            }, {
              label: 'pay'
            }, {
              label: 'message'
            }, {
              label: 'message_admin'
            }, {
              label: 'chat_admin'
            }, {
              label: 'chat_system'
            }, {
              label: 'link_admin'
            }, {
              label: 'pay_game_admin'
            }, {
              label: 'gateway_game_admin'
            }]
          }, {
            label: '玩家账号权限',
            children: [{
              label: 'auth'
            }, {
              label: 'ads'
            }, {
              label: 'pay'
            }, {
              label: 'message'
            }, {
              label: 'chat'
            }]
          }, {
            label: '其他权限',
            children: [{
              label: 'mail_admin'
            }, {
              label: 'auth2'
            }, {
              label: 'system'
            }, {
              label: 'pay_system'
            }, {
              label: 'message_system'
            }, {
              label: 'gateway_system'
            }, {
              label: 'auth_system'
            }]
          }]
          // scope: ['auth', 'auth_game_admin', 'message', 'message_admin', 'chat_admin', 'chat_system', 'ads_rw', 'pay_game_admin', 'pay', 'gateway_game_admin', 'link_admin', 'mail_admin', 'system', 'gateway_system', 'chat', 'pay_system', 'ads', 'message_system', 'auth2', 'auth_system']
          // scope: ['auth', 'ads', 'auth_game_admin', 'ads_rw', 'pay', 'message', 'message_admin', 'chat', 'chat_admin', 'chat_system', 'pay_game_admin', 'gateway_game_admin', 'link_admin', 'mail_admin', 'auth2', 'system', 'pay_system', 'message_system', 'gateway_system', 'auth_system']
        },
        formData: {
          env: 'dev',
          service: 'pay2',
          game: 'tgstest',
          clientId: '',
          authType: '0',
          userType: 'game',
          username: 'tgstest-admin',
          password: '4ECfyqRERWXkzUwMn6cg',
          token: '',
          authWay: 'auth',
          queryMethod: 'GET',
          queryPath: '',
          params: [{
            key: '',
            value: ''
          }],
          scopeList: []
        },
        nameUrl: '',
        accessToken: ''
      }
    },
    methods: {
      // 获取scope
      getScopes() {
        let arr = this.$refs.tree.getCheckedKeys(true)
        this.formData.scopeList = Array.from(new Set(arr))
      },
      // 添加参数
      addParams() {
        this.formData.params.push({})
      },
      isBlank() {
        let l = this.formData.params.length - 1
        if (this.formData.params[l].key || this.formData.params[l].value) {
          this.addParams()
        }
      },
      // 删除参数
      removeParam(idx) {
        this.formData.params.splice(idx, 1)
      },
      // 获取参数
      getParams() {
        let l = this.formData.params.length
        let data = {}
        if (l) {
          for (let i = 0; i < l; i++) {
            let key = this.formData.params[i].key
            let value = this.formData.params[i].value
            data[key] = value
          }
        }
        return data
      },
      send(formName) {
        this.$refs[formName].validate((valid) => {
          if (valid) {
            this.formData.clientId = this.formData.game + ':1.0.0'
            this.getScopes()
            this.getNameAddr(this.formData.env)
          } else {
            return false
          }
        })
      },
      // 获取name服务的地址
      getNameAddr(env) {
        let that = this
        if (env != "gold") {
          env = "-" + env
        } else {
          env = ''
        }
        let url = "https://eve" + env + ".pf.tap4fun.com:10443/config"
        axios({
          method: 'GET',
          url: url,
          params: {
            client_id: that.formData.clientId
          },
          responseType: 'json'
        }).then(async function (res) {
          that.nameUrl = res.data.cfn.servers.name
          let authdata = { client_id: that.formData.clientId };
          let apiData = { client_id: that.formData.clientId, service: that.formData.service };
          // 如果验证类型为”用户名密码“，则先获取token
          if (that.formData.authType == "0") {
            authdata.service = that.formData.authWay
            let authUrl = await that.getServiceAddr('GET', authdata)
            let authorizeData = {}
            authorizeData.client_id = that.formData.clientId
            authorizeData.user = that.formData.userType + ':' + that.formData.username
            authorizeData.password = that.formData.password
            authorizeData.scope = that.formData.scopeList.join()
            await that.authorize(authUrl, authorizeData)
          } else {
            that.accessToken = that.formData.token
          }
          // 调用获取服务的方法
          serviceUrl = await that.getServiceAddr(that.formData.queryMethod, apiData)
          let serviceData = that.getParams()
          serviceData.access_token = that.accessToken
          // 发送api请求
          that.checkAPI(serviceUrl, serviceData)
        })
      },
      // 获取具体服务的地址
      async getServiceAddr(queryMethod, data) {
        let url
        await axios({
          url: this.nameUrl + "/locate",
          method: queryMethod,
          params: data,
          responseType: "json"
        }).then((res) => {
          url = res.data.schema + "://" + res.data.host + ":" + res.data.https_port + res.data.path
        })
        return url
      },
      // 获取access_token
      async authorize(baseUrl, data) {
        await axios({
          url: baseUrl + "/authorize", //请求地址
          method: 'GET',   //请求方式
          params: data, //请求参数
          responseType: "json"
        }).then((res) => {
          this.accessToken = res.data.access_token
        })
      },
      // 调试api
      checkAPI(baseUrl, data) {
        axios({
          url: baseUrl + this.formData.queryPath, //请求地址
          method: 'GET',   //请求方式
          params: data, //请求参数
          responseType: "json"
        }).then((res) => {
          let code = document.getElementById("response")
          code.innerHTML = JSON.stringify(res, null, 2)
          hljs.highlightBlock(code);
        })
      }
    }
  })
</script>

</html>